<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>微服务 | Butterfly</title><meta name="author" content="Charles"><meta name="copyright" content="Charles"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="单体架构一个归档包，包含所有功能的应用程序，我们通常称为单体应用  优点：架构简单，开发，测试，部署方便。 缺点：复杂性高。，部署慢，频率低，只能全量部署，影响的范围大，风险高。扩展能力低，比如用户模块是一个cpu密集的模块，要想提高应用效率，只能加钱买一个cpu更好的服务器，内容模块属于IO密集的模块，只能替换内存更好的服务器。没有办法只针对这个模块做扩展，阻碍技术创新，如果想要将springm">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务">
<meta property="og:url" content="https://18844683936.github.io/2021/06/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="Butterfly">
<meta property="og:description" content="单体架构一个归档包，包含所有功能的应用程序，我们通常称为单体应用  优点：架构简单，开发，测试，部署方便。 缺点：复杂性高。，部署慢，频率低，只能全量部署，影响的范围大，风险高。扩展能力低，比如用户模块是一个cpu密集的模块，要想提高应用效率，只能加钱买一个cpu更好的服务器，内容模块属于IO密集的模块，只能替换内存更好的服务器。没有办法只针对这个模块做扩展，阻碍技术创新，如果想要将springm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/144952-851510.png">
<meta property="article:published_time" content="2021-06-28T20:00:01.000Z">
<meta property="article:modified_time" content="2022-07-24T20:09:19.489Z">
<meta property="article:author" content="Charles">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/144952-851510.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://18844683936.github.io/2021/06/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '微服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-24 17:09:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/144952-851510.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Butterfly</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-28T20:00:01.000Z" title="发表于 2021-06-28 17:00:01">2021-06-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-24T20:09:19.489Z" title="更新于 2022-07-24 17:09:19">2022-07-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="微服务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h3><p>一个归档包，包含所有功能的应用程序，我们通常称为单体应用</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202106/28/170236-803062.png" alt="image-20210628170235406"></p>
<p>优点：架构简单，开发，测试，部署方便。</p>
<p>缺点：复杂性高。，部署慢，频率低，只能全量部署，影响的范围大，风险高。扩展能力低，比如用户模块是一个cpu密集的模块，要想提高应用效率，只能加钱买一个cpu更好的服务器，内容模块属于IO密集的模块，只能替换内存更好的服务器。没有办法只针对这个模块做扩展，阻碍技术创新，如果想要将springmvc替换为webflux，将会带来巨大的改动，因为所有的东西都在一起。</p>
<h3 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h3><p>由于单体架构在搭建复杂的应用的时候会出现各种各样的问题，所以就将这个复杂的应用拆分成小型的应用。这些小型应用通过协作，共同构成一个系统。小型的服务就是微服务</p>
<p>微服务的特性：</p>
<ol>
<li>每个微服务可独立运行在自己的进程里，有自己的进程</li>
<li>一系列独立运行的微服务共同构建起整个系统</li>
<li>每个服务为独立的业务开发，一个微服务只关注某个特定的功能，例如订单管理，用户管理</li>
<li>可以使用不同的语言与数据存储技术，契合项目情况和团队实例</li>
<li>微服务之间通过轻量级通信机制进行通信，例如REST API，要能够跨平台</li>
<li>全自动部署机制，自动化的部署，测试</li>
</ol>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202106/28/171950-789655.png" alt="image-20210628171835556"></p>
<p><strong>微服务优点：</strong></p>
<ol>
<li>单个服务更易于开发，维护，局部的修改</li>
<li>单个微服务启动较快</li>
<li>局部修改容易部署</li>
<li>技术栈不受限</li>
<li>按需伸缩，比如某个服务是cpu密集的，就把他迁移到更好的cpu服务器上</li>
</ol>
<p><strong>微服务缺点：</strong></p>
<ol>
<li>运维要求高</li>
<li>分布式固有的复杂性，比如说网络延迟，分布式事务等等</li>
<li>重复劳动，比如说A服务中有一个StringUtil，B中也有一个StringUtil，这样就导致了重复劳动，如果使用maven的话，也避免不了跨语言的问题</li>
</ol>
<p><strong>微服务的使用场景</strong>：</p>
<ol>
<li>大型，复杂的项目</li>
<li>有快速的需求</li>
<li>访问压力大。</li>
</ol>
<p><strong>不适合用微服务的场景：</strong></p>
<ol>
<li>业务稳定</li>
<li>迭代周期长</li>
</ol>
<h3 id="微服务拆分"><a href="#微服务拆分" class="headerlink" title="微服务拆分"></a>微服务拆分</h3><p><strong>微服务拆分－方法论</strong></p>
<ol>
<li>领域驱动设计(Domin Driven Design),鼓励我们对要解决的问题进行建模，并且识别出若干个子领域，每个子领域解决不同的问题，推荐开发，测试，产品使用同一的语言进行沟通，比如说uml，可以减少不同工种的沟通障碍,强调建模</li>
<li>面向对象，我们在拆分微服务的时候，也应该使用状态或者行为来，微服务的状态是什么，也就是微服务是什么，里面有什么，微服务的行为是什么，也就是说这个微服务能够提供哪些功能。by name 状态，by verb 行为。</li>
</ol>
<p><strong>心得</strong></p>
<ol>
<li>职责划分：规定好这个微服务的边界，以后这个微服务就关注职责以内的东西就好了，比如订单微服务只关注订单相关的业务，其他的业务都不应该放到这个微服务里面</li>
<li>通用性划分：将通用功能做成微服务，比方说，用户中心，消息中心等</li>
</ol>
<p><strong>微服务拆分-合理的粒度</strong></p>
<ol>
<li>良好的满足业务</li>
<li>幸福感，你的团队不会觉得微服务太大难以维护，部署也非常高效，不会每次都发布非常多的微服务</li>
<li>增量迭代，微服务之间相对独立，每次迭代只会发布有限的微服务</li>
<li>持续进化，对于某个微服务，即便是以后需要换编程语言，你也会觉得问题不大，可以搞 </li>
<li>微服务的拆分是动态进行的，是不断调整的过程</li>
</ol>
<p><strong>架构图</strong></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202108/16/142638-464151.png" alt="image-20210701140201586"></p>
<h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><p><strong>项目目录</strong></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/01/163810-893706.png" alt="image-20210701163803639"></p>
<p>mybatis 通用mapper 4 </p>
<p>路径：<a target="_blank" rel="noopener" href="https://github.com/abel533/Mapper/">https://github.com/abel533/Mapper\</a></p>
<ol>
<li></li>
<li><p>maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tk.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>添加注解在启动类上面</p>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/01/171555-257340.png" alt="image-20210701170047941"></p>
</li>
<li><p>添加配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/user-center</span></span><br></pre></td></tr></table></figure></li>
<li><p>代码生成器</p>
<ul>
<li><p>添加maven插件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">        $&#123;basedir&#125;/src/main/resources/generator/generatorConfig.xml</span><br><span class="line">      <span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.29<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tk.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在resourse目录下创建generator/generatorConfig.xml</p>
</li>
<li><p>从文档中粘贴代码并稍作修改</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;generator/config.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">&quot;Mysql&quot;</span> <span class="attr">targetRuntime</span>=<span class="string">&quot;MyBatis3Simple&quot;</span> <span class="attr">defaultModelType</span>=<span class="string">&quot;flat&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beginningDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;endingDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mappers&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tk.mybatis.mapper.common.Mapper&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;caseSensitive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">&quot;$&#123;jdbc.driverClass&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">connectionURL</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">userId</span>=<span class="string">&quot;$&#123;jdbc.user&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">password</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--实体--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.charles.usercenter.domain.entity.$&#123;moduleName&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">targetProject</span>=<span class="string">&quot;src/main/java&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        mapper.xml--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.charles.usercenter.dao.$&#123;moduleName&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">targetProject</span>=<span class="string">&quot;src/main/resources&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        mapper接口--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.charles.usercenter.dao.$&#123;moduleName&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">targetProject</span>=<span class="string">&quot;src/main/java&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">type</span>=<span class="string">&quot;XMLMAPPER&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        为哪张表生成--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;$&#123;tableName&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">sqlStatement</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>在同级目录下面创建config.properties，将配置文件中的占位符填充</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">jdbc.driverClass</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">jdbc.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/user-center</span></span><br><span class="line"><span class="meta">jdbc.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.password</span>=<span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#模块名称</span></span><br><span class="line"><span class="attr">moduleName</span>=<span class="string">user</span></span><br><span class="line"><span class="comment">#表名</span></span><br><span class="line"><span class="attr">tableName</span>=<span class="string">user</span></span><br></pre></td></tr></table></figure></li>
<li><p>在maven插件里面生成代码</p>
</li>
<li><p>遇到这个问题导致生成的表和想象中不一样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[WARNING] Table Configuration user matched more than one table (user_center..user,mysql..user)</span><br></pre></td></tr></table></figure>

<p>解决办法：在数据库连接地址后面添加nullCatalogMeansCurrent=true这个参数</p>
</li>
</ul>
</li>
</ol>
<h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><ol>
<li><p>整合lombok插件</p>
<ul>
<li><p>@Getter</p>
</li>
<li><p>@Setter</p>
</li>
<li><p>@ToString</p>
</li>
<li><p>@EqualsAndHashCode</p>
</li>
<li><p>@RequeredArgsContructor 给所有常量熟悉生成构造方法</p>
</li>
<li><p>以上5个注解可用@Data来替代</p>
</li>
<li><p>@NoArgsContructor 无参构造</p>
</li>
<li><p>@AllArgsContructor 全参构造</p>
</li>
<li><p>@Builder ：</p>
<p>没有builder的时候，属性都是一个一个set进去的，如果用builder 的话，可以链式set，建造者模式</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/10/170243-936785.png" alt="image-20210702093624840"></p>
</li>
<li><p>@CleanUp</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/10/170230-709353.png" alt="image-20210702094119828">可以安全的关闭流，不用写那么多try catch 了</p>
</li>
</ul>
</li>
<li><p>工作流程</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/02/110534-716242.png" alt="image-20210702110533092"></p>
</li>
<li><p>使用RestTemplate来服务间相互调用</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/05/092804-183889.png" alt="image-20210702141845790"></p>
<p>​       <img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/02/152843-7201.png" alt="image-20210702141919255"></p>
</li>
<li><p>整合SpringCloudAlibaba</p>
<p>​        版本兼容问题：</p>
<p>​     <a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">https://github.com/alibaba/spring-cloud-alibaba/wiki/版本说明</a></p>
<p>​    <a target="_blank" rel="noopener" href="https://start.spring.io/actuator/info">https://start.spring.io/actuator/info</a>  看这个选择相应版本的cloud</p>
<ul>
<li><p>整合SpringCloud</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></p>
</li>
<li><p>```xml</p>
<pre><code>&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;GreenWich.SR1&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 整合SpringCloudAlibaba</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;xml</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;0.9.0.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">      &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">      &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>Nacos</p>
<p>让服务消费者感知到服务提供者的地址变化—服务发现,Nacos 是一个服务发现组件，也是一个配置服务器，管理微服务的配置</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/05/092539-700984.png" alt="image-20210705092432193">启动的时候向Server注册，关闭的时候清除Server中的信息</p>
<p>​                 如果用户中心的地址发生变化，去修改内容中心的代码是不现实的，那么怎么样服务消费者总能够找到服务提供者呢？</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/13/112228-809281.png" alt="image-20210713112226859">用户中心启动的时候向mysql中插入一条数据，如果停止用户中心的时候就向mysql将这条数据删除，这就是一个简单的服务发现功能，内容中心想要发现用户中心，只需要向mysql发送一条sql就ok了 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> registry <span class="keyword">where</span> service_name <span class="operator">=</span> <span class="string">&#x27;user-center&#x27;</span> <span class="keyword">and</span> status <span class="operator">=</span> <span class="string">&#x27;UP&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这样就能筛选出所有的正常的微服务实例了，不管用户微服务的地址怎么变化，我总能找得到微服务了，</p>
<ul>
<li>问题1：如果服务发现组件挂了，所有的微服务都无法正常使用了，所以，一般微服务都会做一个缓存，定时的查找服务，然后取服务的时候都是从缓存中取，通过这种方式能够提升性能和稳定性</li>
<li>问题2：某个微服务挂掉后应该怎么办，加一个字段：last_heartbeat ,每个微服务都向服务发现组件发送心跳，告诉服务发现组件自己是活着的，如果服务发现组件发现有一个实例好久都没有给我发送组件了，就认为这个实例已经挂了，就把状态标记为down</li>
</ul>
<p><strong>什么是Nacos</strong></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202207/24/164400-717982.png" alt="image-20210713112741048"></p>
<p>Nacos是一个服务发现组件和配置服务器，他解决了两个问题</p>
<ol>
<li>服务A如何找到服务B的问题</li>
<li>管理微服务的配置</li>
</ol>
<p>Nacos开发文档</p>
<p><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/quick-start.html">https://nacos.io/zh-cn/docs/quick-start.html</a></p>
<p>Nacos集成：</p>
<ol>
<li><p>添加依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>写配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-center</span></span><br></pre></td></tr></table></figure></li>
<li><p>看文档启动nacos</p>
</li>
<li><p>使用Nacos来获取指定的微服务地址<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/140856-580527.png" alt="image-20210715140856483"></p>
</li>
<li><p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20210715140957620.png" alt="image-20210715140957620"></p>
<ul>
<li>最大的时Namespace命名空间，默认的namespace是public，主要实现隔离，比如说我们有三个环境，开发环境，测试环境，生产环境，就可以建3个Namespace 来实现隔离</li>
</ul>
</li>
</ol>
<ul>
<li><p>在NameSpace之下是Group分组，默认的Group是defualt，可以将不同的微服务放在同一个Group中，方便管理</p>
<ul>
<li>Service就是微服务，比如说用户微服务，内容微服务等等</li>
</ul>
</li>
<li><p>一个Service又能包括多个Cluster</p>
<ul>
<li>Cluster是对指定微服务的虚拟划分，比如说，公司有北京机房和南京机房，为了容灾，用户中心微服务同时部署在了北京机房和南京机房，这时候我们就能为北京机房的用户中心起个集群名称叫北京，南京机房的用户中心叫南京，还可以让南京机房的内容中心尽量调南京机房的用户中心，这样还可以提升性能</li>
</ul>
</li>
<li><p>Instance就是微服务的实例  </p>
<ul>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20210715143939835.png" alt="image-20210715143939835">配置Namespace和集群名称，注意Namespace写uuid，集群名称自定义</li>
</ul>
</li>
</ul>
<ol start="6">
<li><p>元数据</p>
<ul>
<li><p>可以用来描述微服务</p>
</li>
<li><p>做版本兼容，微服务可能是多个版本共存的，V1只能调</p>
</li>
<li><p>V1，V2只能调用V2<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/144358-937587.png" alt="image-20210715144356602"></p>
</li>
</ul>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/150423-375566.png" alt="image-20210715144758234"></p>
</li>
</ol>
</li>
<li><p>Ribbon 负载均衡</p>
<ul>
<li><p>服务端侧负载均衡</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/162614-463131.png" alt="image-20210715162152517">当请求过来时，先打到Nginx上，然后由Nginx通过负载均衡算法，计算一下打到那个实例上面</p>
</li>
<li><p>客户端测负载均衡</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/162925-812712.png" alt="image-20210715162805873">客户端测通过DiscoverClient找到服务器，根据规则来选择要请求的服务器，实现如下：</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/16/134250-903980.png" alt="image-20210715163358092"></p>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/164458-495068.png" alt="image-20210715164456190"></p>
</li>
<li><p>为RestTemplate整合Ribbon：</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/164652-267186.png" alt="image-20210715164649470"></br></p>
<p>  <img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/164927-538661.png" alt="image-20210715164925915"></p>
</li>
<li><p>Ribbon的配置</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/15/165801-559457.png" alt="image-20210715165533920"></p>
</li>
<li><p>负载均衡规则</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/16/134237-472495.png" alt="image-20210715170615449"></p>
</li>
<li><p>细粒度配置Ribbon负载均衡规则，比如说，默认的ZoneAvoidanceRule满足不了我们项目上的需求，要把这个规则改成随机，Ribbon支持细粒度的配置，假设内容中心同时调用两个微服务–用户中心和微服务A，Ribbon可以实现调用用户中心实现随机，调用微服务A使用默认的规则</p>
<ol>
<li><p>java代码配置:  配置位置不同的原因是避免Spring出现父子上下文重叠的问题，可能导致事务部生效，但是如果分开的话，就会导致这个配置是全局配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个类写到启动文件目录内，name = 服务的名字，configuration=下面的那个配置类.class</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;user-center&quot;,configuration = RibbonConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCenterRibbonConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//这个类写在启动文件目录之外</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置属性配置<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/16/141836-577678.png" alt="image-20210716141012819"></p>
</li>
<li><p>相关配置都可以使用java代码配置和配置文件配置，如下，很简单</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20210716142855617.png" alt="image-20210716142855617"></p>
</li>
</ol>
</li>
</ul>
<ul>
<li><p>Ribbon的懒加载：只有代码执行到这里的时候，才会创建RibbonClient对象，这样会导致第一次加载非常慢，解决方法如下</p>
<ol>
<li><p>修改配置类<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/19/103420-471837.png" alt="image-20210716143049472"></p>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/19/103308-285033.png" alt="image-20210716143356670"></p>
</li>
</ol>
</li>
</ul>
<p>​                               也是细粒度配置</p>
<ul>
<li><p>Ribbon微服务权重，把性能好的机器权重设置的高一些，性能差的机器权重低一些</p>
<ol>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/19/084924-996949.png" alt="image-20210716151405157"></p>
</li>
<li><p>但是Nacos的权重设置都不适用于Ribbon的负载均衡规则，可以自定义一个负载均衡规则，让他支持权重，可以实现IRule接口的三个方法或者继承如下类</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosWeightedRule</span>  <span class="keyword">extends</span> <span class="title">AbstractLoadBalancerRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NacosDiscoveryProperties nacosDiscoveryProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig iClientConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//读取配置文件，并初始化</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BaseLoadBalancer loadBalancer = (BaseLoadBalancer) <span class="keyword">this</span>.getLoadBalancer();</span><br><span class="line"><span class="comment">//            log.info(&quot;lb=&#123;&#125;&quot;,loadBalancer);</span></span><br><span class="line"></span><br><span class="line">            String name = loadBalancer.getName();</span><br><span class="line">            <span class="comment">//实现负载均衡算法</span></span><br><span class="line">            <span class="comment">//拿到服务发现的相关api</span></span><br><span class="line">            NamingService namingService = nacosDiscoveryProperties.namingServiceInstance();</span><br><span class="line">            Instance instance = namingService.selectOneHealthyInstance(name);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;port=&#123;&#125;,instance=&#123;&#125;&quot;</span>,instance.getPort(),instance);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NacosServer(instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Ribbon 同集群优先</p>
<p>要考虑容灾，要把用户中心和内容中心服务器都同时部署在北京机房和南京机房，同机房优先调用，这就要使用Cluster</p>
<ol>
<li><p>现在配置文件中配置好集群名称</p>
</li>
<li><p>```java<br>@Slf4j<br>public class NacosSameClusterWeightedRule extends AbstractLoadBalancerRule {</p>
<pre><code>@Autowired
private NacosDiscoveryProperties nacosDiscoveryProperties;
@Override
public void initWithNiwsConfig(IClientConfig iClientConfig) &#123;

&#125;

@Override
public Server choose(Object o) &#123;
    try &#123;
        //拿到配置文件中的集群名称
        String clusterName = nacosDiscoveryProperties.getClusterName();

        BaseLoadBalancer loadBalancer = (BaseLoadBalancer) this.getLoadBalancer();

        //想要请求的微服务名称
        String name = loadBalancer.getName();
        //拿到服务发现组件的相关api
        NamingService namingService = nacosDiscoveryProperties.namingServiceInstance();

        //1.找到改服务下的所有实例A
        List&lt;Instance&gt; instances = namingService.selectInstances(name, true);
        //2.过滤出相同集群下所有实例B
        List&lt;Instance&gt; sameClusterInstance = instances.stream().filter(instance -&gt; Objects.equals(instance.getClusterName(), clusterName)).collect(Collectors.toList());
        //3.如果B是空，就用A
        List&lt;Instance&gt; instancesToBeChosen =new ArrayList&lt;&gt;();
        if (CollectionUtils.isEmpty(sameClusterInstance))&#123;
            log.warn(&quot;跨集群调用&quot;);
            instancesToBeChosen = instances;
        &#125;else &#123;
            instancesToBeChosen=sameClusterInstance;
        &#125;
        //4.基于权重的负载均衡算法，返回一个实例
        Instance instance = ExtendBalancer.getHostByRandomWeight2(instancesToBeChosen);
        return new NacosServer(instance);
    &#125; catch (NacosException e) &#123;
        log.error(&quot;发生异常啦&quot;,e);
</code></pre>
<p>//            e.printStackTrace();</p>
<pre><code>        return null;
    &#125;
&#125;
</code></pre>
<p>}</p>
<p>class ExtendBalancer extends Balancer {</p>
<pre><code>public static Instance getHostByRandomWeight2(List&lt;Instance&gt; hosts) &#123;
    return getHostByRandomWeight(hosts);
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - 基于元数据的版本控制</span><br><span class="line"></span><br><span class="line">     有时候微服务的版本间相互不兼容，有时候V1版本只能调用V1版本，这时候就需要用到元数据的版本控制了</span><br><span class="line"></span><br><span class="line">   - Namespace 的用法</span><br><span class="line"></span><br><span class="line">     只有配置了相同Namespace的微服务才能相互调用</span><br><span class="line"></span><br><span class="line">7. Feign</span><br><span class="line"></span><br><span class="line">   ​	声明式HTTP客户端</span><br><span class="line"></span><br><span class="line">   - 集成</span><br><span class="line"></span><br><span class="line">     1. 导入maven依赖</span><br><span class="line"></span><br><span class="line">        &#96;&#96;&#96;xml</span><br><span class="line">                &lt;dependency&gt;</span><br><span class="line">                    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>在启动类写注解 @EnableFeignClients</p>
</li>
<li><p>创建Feign请求接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;user-center&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserCenterFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/users/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">UserDTO <span class="title">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>创建参数为对象的GET接口，要加注解SpringQueryMap，POST的话，值需要@RequestBody</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20210720134329436.png" alt="image-20210720134329436"></p>
</li>
<li><p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserDTO userDTO = userCenterFeignClient.findById(userId);</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>Feign的组成和扩展</p>
<ol>
<li><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/091739-895066.png" alt="image-20210720095958022"></li>
</ol>
</li>
<li><p>设置Feign的日志级别</p>
<ol>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/20/100326-150682.png" alt="image-20210720100323958"></p>
</li>
<li><p>java代码方式配置（局部配置）</p>
<ul>
<li><p>```java<br>@FeignClient(name = “user-center”,configuration = UserCenterFeignClientConfiguration.class)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;java</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 这里不用加@Configuration注解，加了反而会变成全局配置（Spring 父子上下文），还得放到@ComponentScan外面，</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public class UserCenterFeignClientConfiguration &#123;</span><br><span class="line">      @Bean</span><br><span class="line">      public Logger.Level level()&#123;</span><br><span class="line">          &#x2F;&#x2F;让Feign打印所有请求的细节</span><br><span class="line">          return Logger.Level.FULL;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>```yml<br>logging:<br>  level:<br> com.charles.contentcenter.feignclient.UserCenterFeignClient: debug</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  3. java代码方式配置（全局配置）</span><br><span class="line"></span><br><span class="line">     - 让父子上下文ComponentScan重叠 ，不建议使用</span><br><span class="line">     - 启动类上面的注解写全局配置![image-20210720105405286](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202107&#x2F;20&#x2F;105408-754917.png)</span><br><span class="line"></span><br><span class="line">  4. 配置文件方式（局部配置）</span><br><span class="line"></span><br><span class="line">     - ![image-20210720104833462](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202107&#x2F;20&#x2F;111001-613939.png)</span><br><span class="line">  - ![image-20210720111054862](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202107&#x2F;20&#x2F;111105-559160.png) （全局配置）</span><br><span class="line">    </span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">- Feign的其他配置项目</span><br><span class="line"></span><br><span class="line">  1. 使用代码的配置项目有![image-20210720111404761](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202112&#x2F;21&#x2F;213419-480133.png)</span><br><span class="line">  2. 使用配置属性的配置项目有![image-20210720111439144](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202107&#x2F;20&#x2F;111806-792431.png)</span><br><span class="line"></span><br><span class="line">- 脱离Ribbon使用Feign</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;java</span><br><span class="line">  @FeignClient(name &#x3D; &quot;baidu&quot;,url &#x3D; &quot;www.baidu.com&quot;)</span><br><span class="line">  public interface TestBaiduFeignClient &#123;</span><br><span class="line">  </span><br><span class="line">      @GetMapping(&quot;&quot;)</span><br><span class="line">      String index();</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202107/20/140229-170563.png" alt="image-20210720140222224"></p>
</li>
<li><p>Feign性能优化</p>
<ol>
<li><p>配置连接池</p>
<ul>
<li><p>```pom</p>
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        - ![image-20210720141837873](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202112&#x2F;21&#x2F;213349-734635.png)</span><br><span class="line"></span><br><span class="line">     2. 设置合理的日志级别</span><br><span class="line"></span><br><span class="line">   - Feign常见问题解决</span><br><span class="line"></span><br><span class="line">     http:&#x2F;&#x2F;www.imooc.com&#x2F;article&#x2F;289005</span><br><span class="line"></span><br><span class="line">8. Sentinel</span><br><span class="line"></span><br><span class="line">   - 雪崩效应</span><br><span class="line"></span><br><span class="line">     1. ![image-20211221213837201](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202112&#x2F;21&#x2F;213839-82293.png)</span><br><span class="line">     2. 例如有4个微服务，ABCD，当A服务不可用的时候，B服务打在A服务上面的请求会一直等待到请求超时为止，一个请求占用一个线程，如果是一个高并发项目，还不等到返回超时B的线程就已经爆满了，导致B服务最终也GG了，以此类推，所有的服务都挂了最后。</span><br><span class="line">     3. 解决方案</span><br><span class="line">        - **超时** : 如果将请求的超时时间设置成1s的话，B服务的线程就能足够快的释放，这样就可以解决问题了</span><br><span class="line">        - **限流**:  先测试B服务能承受的最大并发量，然后将B服务限流，这样如果A服务不工作了，B服务也不至于被拖到宕机</span><br><span class="line">        - **仓壁模式** :</span><br><span class="line">          1.  泰坦尼克号的构造，每个船舱之间用钢板隔开，即使有两个舱进水后，船还依旧能够运行</span><br><span class="line">          2. 软件上的表现就是，可以给每一个Controller配置一个连接池，用这个连接池来把Controller隔开</span><br><span class="line">        - **断路器模式**: </span><br><span class="line">          1. 现实中的断路器，当电路短路的时候，断路器会检测当前电流过大，然后缎断点 -- 检测+开关的功能</span><br><span class="line">          2. 软件中的断路器，</span><br><span class="line">             - 可以针对某个API设置5s内的错误率，错误次数，如果达到阈值就直接跳闸，确保不被拖死 </span><br><span class="line">             - 如果该接口过一段时间好用了该怎么办呢？--半开状态</span><br><span class="line">             - ![image-20211221220259630](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202112&#x2F;21&#x2F;220335-459593.png)</span><br><span class="line"></span><br><span class="line">   - Sentinel （轻量级 流量控制，熔断降级库）</span><br><span class="line"></span><br><span class="line">     1. 整合</span><br><span class="line"></span><br><span class="line">        - 添加依赖</span><br><span class="line"></span><br><span class="line">          &#96;&#96;&#96;pom</span><br><span class="line">          &lt;dependency&gt;</span><br><span class="line">              &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">              &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;&#x2F;artifactId&gt;</span><br><span class="line">          &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>   整合sentinel后会暴露这个端点  /actuator/sentinel，基于actuator可以查看sentinel是否整合成功</p>
</li>
</ul>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这个端点默认是隐藏的，需要修改配置来查看</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &#x27;*&#x27;</span><br></pre></td></tr></table></figure></li>
<li><p>去github下载sentinel控制台</p>
</li>
<li><p>集成</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sentinel:</span><br><span class="line">  transport:</span><br><span class="line">    dashboard: 127.0.0.1:8080</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>介绍</p>
<ul>
<li><p>实时监控<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20211228202318032.png" alt="image-20211228202318032">每秒的访问量</p>
</li>
<li><p>簇点链路</p>
<ol>
<li><p>可以看到之前访问的所有资源路径<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202112/28/202709-643332.png" alt="image-20211228202657479"></p>
</li>
<li><p>可以设置流控规则</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202112/28/203127-536438.png" alt="image-20211228203127124"></p>
<p>资源名：默认是资源路径，也可以不是资源路径</p>
<p>针对来源：比如说有两个微服务来访问这个资源，就可以通过设置该字段来进行针对，default表示默认，不区分来源</p>
<p>阈值类型：如果是QPS，就是当访问/shares/1的QPS达到单机阈值的时候用下面规则开始限流</p>
<p>流控模式：</p>
<ul>
<li><p>直接：如果访问该资源达到阈值的话，就限流</p>
</li>
<li><p>关联：当关联的资源达到阈值的话，就限流自己，应用场景是，对同一资源有两个API，一个是读取数据，另一个是写数据，那么读取数据的时候写数据就会慢一些，写数据的时候读取数据就会慢一些，如果你比较侧重于读取数据的话，就把关联资源设置成读资源，把资源名设置为写资源，这样如果读资源的Qps达到阈值的时候，写资源就会被限流，这样读资源速度就不会受到影响</p>
</li>
<li><p>链路：只记录链路上面的流量</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20211228221624975.png" alt="image-20211228221624975"></p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20211228221648757.png" alt="image-20211228221648757"></p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20211228221716001.png" alt="image-20211228221716001"></p>
<p>细粒度的限流 test-a 路径访问 common资源</p>
</li>
<li><p>流控效果</p>
<ol>
<li><p><strong>快速失败</strong>：直接抛出异常</p>
</li>
<li><p><strong>WarmUp</strong>：默认coldFactor为3，即请求QPS从（threshold/3）开始，经多少预热时长才逐渐升至设定的QPS阈值。</p>
<p>WarmUp方式，即预热/冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过”冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/083704-964892.png" alt="image-20211228222618159"></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202112/28/222714-711983.png" alt="image-20211228222715775">刚开始的阈值是30多,经过10s后达到最高阈值100</p>
</li>
<li><p><strong>排队等待</strong>：<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/083438-381008.png" alt="image-20211228223420816"></p>
<p>在超时时间内达到阈值    后不会抛出异常，而是排队等待，这样的效果就是每秒请求qps次最多（QPS）</p>
</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
<li><p>降级策略</p>
<ol>
<li><p>RT  平均响应时间</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103085307961.png" alt="image-20220103085307961"></p>
<p>​                        <img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/084955-388693.png" alt="image-20220103084757687"></p>
<p>如果 /shares/1的资源 秒级统计的平均响应时间 大于1ms 并且在5s内通过的时间&gt;=5次，就会触发降级(断路器打开)，直到5s结束，才会关闭降级</p>
<p>RT 默认最大为4900ms，<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/090549-116388.png" alt="image-20220103090247044"></p>
</li>
<li><p>异常比例</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/090919-588340.png" alt="image-20220103090359076"></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/03/092310-310855.png" alt="image-20220103090633476"></p>
<p><strong>1秒持续进入QPS&gt;=5 且 异常比例超过阈值，触发降级，打开断路器，等时间窗口结束 （秒），再关闭降级<br>异常比率的阈值范围是 <code>[0.0 至 1.0]</code></strong></p>
</li>
<li><p>异常数</p>
<ul>
<li><p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103092540474.png" alt="image-20220103092540474"></p>
</li>
<li><p>时间窗口大于60，可能出现问题</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>热点数据</p>
<ol>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103095755981.png" alt="image-20220103095755981"> </li>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103100352551.png" alt="image-20220103100352551">表示限流第一个index 0 ，当a参数的Qps&gt;1的时候 就直接失败，如果不填写a参数，则不会限流</li>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103100658193.png" alt="image-20220103100658193">表示给 特定参数值的 情况 添加限流规则 为2000 . 你一直刷新参数a=5 规则为2000的QPS</li>
<li>是比较特殊的流控规则，对指定的参数限流，甚至支持对指定的参数值限流，适用于存在热点参数，某些参数的qps特别高，并且希望提高api可用性的场景<ol>
<li>需要注意参数类型必须要基本参数类型或者String</li>
</ol>
</li>
</ol>
</li>
<li><p>系统规则</p>
<ol>
<li>load ： 当系统load1 （1分钟的负载）超过阈值，并且 并发线程数超过<strong>系统容量</strong>时触发，建议设置为cpu核心数 * 2.5 .（只对Linux/Unix-like）机器生效<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103102522838.png" alt="image-20220103102522838"></li>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103102630714.png" alt="image-20220103102630714"></li>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103102808991.png" alt="image-20220103102808991"></li>
</ol>
</li>
<li><p>授权规则</p>
<ol>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103103117108.png" alt="image-20220103103117108">表示只允许test1 微服务来访问这个shares/1资源 </li>
</ol>
</li>
</ul>
</li>
<li><p>Sentinel 与控制台通信原理刨析</p>
<ul>
<li><p>控制台是如何获取到微服务的监控信息的？比如说实时监控，控制台是怎么获取到微服务的数据的？</p>
<ol>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103110932868.png" alt="image-20220103110932868"></li>
<li>微服务需要集成transport模块，集成后就会把自己注册到控制台上，并且会时给控制台发送心跳，也就是说 sentinel实现了一套服务发现机制<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103111554772.png" alt="image-20220103111554772" style="zoom:200%;" />控制台知道了微服务的地址之后，想要获取微服务的监控信息，就定时获取微服务上的监控api就ok，想要推送规则给微服务，控制台就调用能够接收推送规则的api就行了</li>
<li>查看api：ip+端口+/api <img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/085945-808891.png" alt="image-20220103111833697"></li>
<li><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103112055905.png" alt="image-20220103112055905"></li>
</ol>
</li>
<li><p>配置项</p>
<ol>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/090002-63934.png" alt="image-20220103112540130"></p>
</li>
<li><p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103112735071.png" alt="image-20220103112735071">比如设置控制台账户密码：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar -Dsentinel.dashboard.auth.username=admin -Dsentinel.dashboard.auth.password=admin sentinel-dashboard-<span class="number">1</span>.<span class="number">6</span>.<span class="number">2</span>.jar</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
</li>
<li><p>Sentinel Api</p>
<ul>
<li><p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220103140706508.png" alt="image-20220103140706508" style="zoom:150%;" /> 关闭掉spring mvc 端点的保护，这样软件就不会受sentinel控制台的保护（为了防止干扰）</p>
</li>
<li><p>```java<br>@RequestMapping(“/test-sentinel-api”)</p>
<pre><code>public String testSentinelApi(@RequestParam(required = false) String a)&#123;
    //定义一个Sentinel 保护的资源
    Entry entry = null;
    String resourceName = &quot;test-sentinel-api&quot;;
    //标记针对来源为test-wfw (在流控规则中有一个针对来源选项，如果选择来源不是test-wfw 的话，就不会对这个接口限流，反之限流  )
    ContextUtil.enter(resourceName,&quot;test-wfw&quot;);
    try &#123;
        entry = SphU.entry(&quot;test-sentinel-api&quot;);
        //被保护的逻辑
        if (StringUtils.isBlank(a))&#123;
            //此时给该资源添加降级策略，但是无论如何只能走到这里，而不会走到降级
            //因为默认情况下，sentinel只会统计BlockException及其子类，对于这个异常不会统计
            //如果希望统计该Api所报的错的话则需要新增一个catch分支
            throw new IllegalArgumentException(&quot;a参数不能为空&quot;);
        &#125;
        return a;
    &#125;
    //如果被限流或者降级了会抛出这个异常
    catch (BlockException e) &#123;
        log.warn(&quot;被限流或者被降级了&quot;,e);
        e.printStackTrace();
        return &quot;被限流或者被降级了&quot;;
    &#125;catch (IllegalArgumentException e)&#123;
        //统计IllegalArgumentException发生的次数，发生占比
        Tracer.trace(e);
        return &quot;非法参数&quot;;
    &#125;finally &#123;
        //推出entry
        if (entry!=null)&#123;
            entry.exit();
        &#125;
        ContextUtil.exit();
    &#125;
&#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - Sphu : 定义资源，监控资源，保护资源</span><br><span class="line"></span><br><span class="line">   - Tracer: 对其他异常进行统计</span><br><span class="line"></span><br><span class="line">   - ContextUtil 可以实现调用来源，还可以标记调用</span><br><span class="line"></span><br><span class="line">5. SentinelResource 注解</span><br><span class="line"></span><br><span class="line">   - 可以使用value &#x3D; &quot;test-sentinel-api&quot; 来代替entry &#x3D; SphU.entry(&quot;test-sentinel-api&quot;);</span><br><span class="line"></span><br><span class="line">   - 可以使用blockHandler &#x3D; &quot;block&quot;  和block方法 ![image-20220103151643689](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;04&#x2F;085910-947267.png)来代替--------------------------![image-20220103151503420](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;04&#x2F;084331-752361.png)--------------------------注意：blcok方法需要返回值和参数需要和主方法一致</span><br><span class="line"></span><br><span class="line">   - 之前需要手动Trace不统计的异常，但是SentinelResource注解默认Trace Throwable 所有异常，所以直接可以省略![image-20220103152012418](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;04&#x2F;084327-248640.png)</span><br><span class="line"></span><br><span class="line">   - 可以区分出限流还是降级了：用fallback属性</span><br><span class="line"></span><br><span class="line">   - &#96;&#96;&#96;java</span><br><span class="line">     @RequestMapping(&quot;&#x2F;test-sentinel-resource&quot;)</span><br><span class="line">         @SentinelResource(value &#x3D; &quot;test-sentinel-api&quot;,blockHandler &#x3D; &quot;block&quot;,fallback &#x3D; &quot;fallback&quot;)</span><br><span class="line">         public String testSentinelResource(@RequestParam(required &#x3D; false) String a)&#123;</span><br><span class="line">            if (StringUtils.isBlank(a))&#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;a cannot be empty&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return a;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         &#x2F;**</span><br><span class="line">          * 处理限流</span><br><span class="line">          * @param a</span><br><span class="line">          * @param e</span><br><span class="line">          * @return</span><br><span class="line">          *&#x2F;</span><br><span class="line">         public String block(String a,BlockException e)&#123;</span><br><span class="line">             log.warn(&quot;限流了 block&quot;,e);</span><br><span class="line">             return &quot;限流了 block&quot;;</span><br><span class="line">         &#125;</span><br><span class="line">     </span><br><span class="line">         &#x2F;**</span><br><span class="line">          * 处理降级</span><br><span class="line">          * 升级到sentinel1.6后，可以处理所有异常，所有的异常都会走到这里来</span><br><span class="line">          * @param a</span><br><span class="line">          * @return</span><br><span class="line">          *&#x2F;</span><br><span class="line">         public String fallback(String a)&#123;</span><br><span class="line">             log.warn(&quot;降级了 fallback&quot;);</span><br><span class="line">             return &quot;降级了 fallback&quot;;</span><br><span class="line">         &#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure></li>
<li><p>将block方法代码抽取到一个类中<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/090212-902824.png" alt="image-20220103153635964">——————————</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/084313-497405.png" alt="image-20220103153731703"></p>
</li>
</ul>
</li>
<li><p>RestTemplate 整合 Sentinel </p>
<ul>
<li><p>再初始化RestTemplate的时候加上该注解就可以整合Sentinel了<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220104090729942.png" alt="image-20220104090729942" style="zoom:150%;" />这样就整合了</p>
</li>
<li><p>Sentinel 提供了一个开关</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">resttemplate:</span></span><br><span class="line"><span class="function">  <span class="title">sentinel</span>:</span></span><br><span class="line"><span class="function">    # 提供<span class="title">SentinelRestTemplate</span>注解开关</span></span><br><span class="line"><span class="function">    <span class="title">enabled</span>: <span class="title">false</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>SentinelRestTemplate 也支持 降级，流控 异常的自定义，和之前SentinelResource注解类似<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/101419-308173.png" alt="image-20220104101418417"></p>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/04/101726-284200.png" alt="image-20220104101534163"></p>
</li>
</ul>
</li>
<li><p>Feign整合Sentinel</p>
<ul>
<li><p>加入配置 就好了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  sentinel:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>默认是没有fallback 等异常处理的，需要再Feign的配置类上面加入属性</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220104111245705.png" alt="image-20220104111245705"></p>
<hr>
<p>再写入fallback类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCenterFeignClientFallBack</span> <span class="keyword">implements</span> <span class="title">UserCenterFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDTO <span class="title">findById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">        userDTO.setWxNickname(<span class="string">&quot;一个默认的用户&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>这样出现异常之后，就会走下面这个配置类了，不会直接抛出异常了</p>
</li>
<li><p>但是上面的方法没有异常类，如果需要获取异常，需要另一种配置属性<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220104200222943.png" alt="image-20220104200222943"></p>
</li>
<li><p>```java<br>@Component<br>@Slf4j<br>public class UserCenterFeignClientFallBackFactory implements FallbackFactory<UserCenterFeignClient> {</p>
<pre><code>@Override
public UserCenterFeignClient create(Throwable e) &#123;
    return new UserCenterFeignClient() &#123;
        @Override
        public UserDTO findById(Integer id) &#123;
            log.warn(&quot;被限流或者降级了&quot;,e);
            UserDTO userDTO = new UserDTO();
            userDTO.setWxNickname(&quot;一个默认的用户&quot;);
            return userDTO;
        &#125;
    &#125;;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">   - ![image-20220104200525083](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;04&#x2F;200527-361009.png)</span><br><span class="line">   </span><br><span class="line">8. Sentinel 规则持久化 目前Sentinel 一重启规则就全丢了</span><br><span class="line"></span><br><span class="line">   - 拉模式![image-20220104201320127](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;04&#x2F;202054-246117.png)FileRefreshableDataSource **定时**从指定文件中读取规则JSON文件【图中的本地文件】，如果发现文件发生变化，就更新规则缓存。</span><br><span class="line"></span><br><span class="line">     FileWritableDataSource 接收控制台规则推送，并根据配置，修改规则JSON文件【图中的本地文件】</span><br><span class="line"></span><br><span class="line">     作者：大目</span><br><span class="line">     链接：http:&#x2F;&#x2F;www.imooc.com&#x2F;article&#x2F;289402</span><br><span class="line">     来源：慕课网</span><br><span class="line">     本文原创发布于慕课网 ，转载请注明出处，谢谢合作</span><br><span class="line"></span><br><span class="line">     1. 导入依赖&lt;img src&#x3D;&quot;C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220104204131258.png&quot; alt&#x3D;&quot;image-20220104204131258&quot; style&#x3D;&quot;zoom:200%;&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">     2. &#96;&#96;&#96;java</span><br><span class="line">        public class FileDataSourceInit implements InitFunc &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void init() throws Exception &#123;</span><br><span class="line">                &#x2F;&#x2F; TIPS: 如果你对这个路径不喜欢，可修改为你喜欢的路径</span><br><span class="line">                String ruleDir &#x3D; System.getProperty(&quot;user.home&quot;) + &quot;&#x2F;sentinel&#x2F;rules&quot;;</span><br><span class="line">                String flowRulePath &#x3D; ruleDir + &quot;&#x2F;flow-rule.json&quot;;</span><br><span class="line">                String degradeRulePath &#x3D; ruleDir + &quot;&#x2F;degrade-rule.json&quot;;</span><br><span class="line">                String systemRulePath &#x3D; ruleDir + &quot;&#x2F;system-rule.json&quot;;</span><br><span class="line">                String authorityRulePath &#x3D; ruleDir + &quot;&#x2F;authority-rule.json&quot;;</span><br><span class="line">                String paramFlowRulePath &#x3D; ruleDir + &quot;&#x2F;param-flow-rule.json&quot;;</span><br><span class="line">        </span><br><span class="line">                this.mkdirIfNotExits(ruleDir);</span><br><span class="line">                this.createFileIfNotExits(flowRulePath);</span><br><span class="line">                this.createFileIfNotExits(degradeRulePath);</span><br><span class="line">                this.createFileIfNotExits(systemRulePath);</span><br><span class="line">                this.createFileIfNotExits(authorityRulePath);</span><br><span class="line">                this.createFileIfNotExits(paramFlowRulePath);</span><br><span class="line">        </span><br><span class="line">                &#x2F;&#x2F; 流控规则</span><br><span class="line">                ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                        flowRulePath,</span><br><span class="line">                        flowRuleListParser</span><br><span class="line">                );</span><br><span class="line">                &#x2F;&#x2F; 将可读数据源注册至FlowRuleManager</span><br><span class="line">                &#x2F;&#x2F; 这样当规则文件发生变化时，就会更新规则到内存</span><br><span class="line">                FlowRuleManager.register2Property(flowRuleRDS.getProperty());</span><br><span class="line">                WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                        flowRulePath,</span><br><span class="line">                        this::encodeJson</span><br><span class="line">                );</span><br><span class="line">                &#x2F;&#x2F; 将可写数据源注册至transport模块的WritableDataSourceRegistry中</span><br><span class="line">                &#x2F;&#x2F; 这样收到控制台推送的规则时，Sentinel会先更新到内存，然后将规则写入到文件中</span><br><span class="line">                WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);</span><br><span class="line">        </span><br><span class="line">                &#x2F;&#x2F; 降级规则</span><br><span class="line">                ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                        degradeRulePath,</span><br><span class="line">                        degradeRuleListParser</span><br><span class="line">                );</span><br><span class="line">                DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());</span><br><span class="line">                WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                        degradeRulePath,</span><br><span class="line">                        this::encodeJson</span><br><span class="line">                );</span><br><span class="line">                WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);</span><br><span class="line">        </span><br><span class="line">                &#x2F;&#x2F; 系统规则</span><br><span class="line">                ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                        systemRulePath,</span><br><span class="line">                        systemRuleListParser</span><br><span class="line">                );</span><br><span class="line">                SystemRuleManager.register2Property(systemRuleRDS.getProperty());</span><br><span class="line">                WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                        systemRulePath,</span><br><span class="line">                        this::encodeJson</span><br><span class="line">                );</span><br><span class="line">                WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);</span><br><span class="line">        </span><br><span class="line">                &#x2F;&#x2F; 授权规则</span><br><span class="line">                ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                        authorityRulePath,</span><br><span class="line">                        authorityRuleListParser</span><br><span class="line">                );</span><br><span class="line">                AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());</span><br><span class="line">                WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                        authorityRulePath,</span><br><span class="line">                        this::encodeJson</span><br><span class="line">                );</span><br><span class="line">                WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);</span><br><span class="line">        </span><br><span class="line">                &#x2F;&#x2F; 热点参数规则</span><br><span class="line">                ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS &#x3D; new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                        paramFlowRulePath,</span><br><span class="line">                        paramFlowRuleListParser</span><br><span class="line">                );</span><br><span class="line">                ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());</span><br><span class="line">                WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS &#x3D; new FileWritableDataSource&lt;&gt;(</span><br><span class="line">                        paramFlowRulePath,</span><br><span class="line">                        this::encodeJson</span><br><span class="line">                );</span><br><span class="line">                ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            private Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">                    source,</span><br><span class="line">                    new TypeReference&lt;List&lt;FlowRule&gt;&gt;() &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">            private Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">                    source,</span><br><span class="line">                    new TypeReference&lt;List&lt;DegradeRule&gt;&gt;() &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">            private Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">                    source,</span><br><span class="line">                    new TypeReference&lt;List&lt;SystemRule&gt;&gt;() &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">            private Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">                    source,</span><br><span class="line">                    new TypeReference&lt;List&lt;AuthorityRule&gt;&gt;() &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">            private Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser &#x3D; source -&gt; JSON.parseObject(</span><br><span class="line">                    source,</span><br><span class="line">                    new TypeReference&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">            private void mkdirIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">                File file &#x3D; new File(filePath);</span><br><span class="line">                if (!file.exists()) &#123;</span><br><span class="line">                    file.mkdirs();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            private void createFileIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">                File file &#x3D; new File(filePath);</span><br><span class="line">                if (!file.exists()) &#123;</span><br><span class="line">                    file.createNewFile();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            private &lt;T&gt; String encodeJson(T t) &#123;</span><br><span class="line">                return JSON.toJSONString(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>在项目的 <code>resources/META-INF/services</code> 目录下创建文件，名为 <code>com.alibaba.csp.sentinel.init.InitFunc</code> ，内容为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 改成上面FileDataSourceInit的包名类名全路径即可。</span></span><br><span class="line"><span class="attr">com.itmuch.contentcenter.FileDataSourceInit</span></span><br></pre></td></tr></table></figure></li>
<li><p>详见：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/289402">http://www.imooc.com/article/289402</a></p>
</li>
</ol>
</li>
<li><p>推模式</p>
</li>
</ul>
</li>
<li><p>生产环境使用Sentinel</p>
</li>
<li><p>集群流控<img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220104220744508.png" alt="image-20220104220744508"></p>
</li>
<li><p>自定义异常页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">UrlBlockHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blocked</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Msg msg = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span>(e <span class="keyword">instanceof</span> AuthorityException)&#123;</span><br><span class="line">           msg = <span class="keyword">new</span> Msg(<span class="number">104</span>,<span class="string">&quot;授权参数不通过&quot;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DegradeException)&#123;</span><br><span class="line">           msg = <span class="keyword">new</span> Msg(<span class="number">101</span>,<span class="string">&quot;降级了&quot;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParamFlowException)&#123;</span><br><span class="line">           msg = <span class="keyword">new</span> Msg(<span class="number">103</span>,<span class="string">&quot;热点参数限流&quot;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FlowException)&#123;</span><br><span class="line">           msg = <span class="keyword">new</span> Msg(<span class="number">100</span>,<span class="string">&quot;限流了&quot;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SystemBlockException)&#123;</span><br><span class="line">           msg = <span class="keyword">new</span> Msg(<span class="number">105</span>,<span class="string">&quot;系统规则(负载/...) 不满足要求&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       httpServletResponse.setStatus(<span class="number">500</span>);</span><br><span class="line">       httpServletResponse.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">       httpServletResponse.setHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">       httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">       <span class="keyword">new</span> ObjectMapper().writeValue(httpServletResponse.getWriter(),msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Sentinel 实现区分来源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRequestOriginParser</span> <span class="keyword">implements</span> <span class="title">RequestOriginParser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseOrigin</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从请求参数中获取名为origin 的参数并返回</span></span><br><span class="line">        <span class="comment">//如果获取不到 origin参数，那么就抛出异常</span></span><br><span class="line">        String origin = request.getParameter(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(origin))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;origin must be specified&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8010/shares/1?origin=broswer">http://127.0.0.1:8010/shares/1?origin=broswer</a> 指定来源为broswer ，<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/101753-888854.png" alt="image-20220106100626720">针对来源如果不一样的话，规则就不会生效</li>
</ul>
</li>
<li><p>Sentinel 针对RestFulUrl的支持</p>
<p> 访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8010/shares/1">http://127.0.0.1:8010/shares/1</a> 和 <a target="_blank" rel="noopener" href="http://127.0.0.1:8010/shares/2">http://127.0.0.1:8010/shares/2</a> 会分别出现两个不同的簇点链路，这样的话，设置规则就得一个一个设置，非常致命</p>
<p>解决方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUrlCleaner</span> <span class="keyword">implements</span> <span class="title">UrlCleaner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">clean</span><span class="params">(String originUrl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//让 /shares/1 和  shares/2 返回一样的值，即支持RestfulUrl</span></span><br><span class="line">        <span class="comment">//返回 /shares/&#123;nums&#125;</span></span><br><span class="line">        log.info(originUrl);</span><br><span class="line">        val split = originUrl.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> Arrays.stream(split).map(string-&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (NumberUtils.isNumber(string))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&#123;number&#125;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> string;</span><br><span class="line">        &#125;).reduce((a,b)-&gt;a+<span class="string">&quot;/&quot;</span>+b).orElse(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220106110721822.png" alt="image-20220106110721822"></p>
<p>这些都是由CommonFilter来实现的，调用每个Servrlet的时候都会调用这个过滤器</p>
<p>再这个filter 里面获取来源</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220106111333609.png" alt="image-20220106111333609"></p>
<hr>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220106111455964.png" alt="image-20220106111455964">获取自定义的处理类，如果没有，就返回默认的””</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/112222-350413.png" alt="image-20220106111807772">获取UrlCleaner，如果没有指定的话，就是默认的UrlCleaner</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/112230-919852.png" alt="image-20220106112228974"></p>
<hr>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220106112514534.png" alt="image-20220106112514534"></p>
<hr>
<p>如果需要自定义Sentinel的功能的时候，可以参照这个过滤器，使用Springmvc的拦截器来实现功能</p>
</li>
</ol>
</li>
</ul>
</li>
<li><p>整合 RocketMq</p>
<ol>
<li><p>管理员审核分享api实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/shares&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareAdminController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShareService shareService;</span><br><span class="line">    <span class="meta">@PutMapping(&quot;/audit/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Share <span class="title">auditById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id, ShareAuditDTO auditDTO)</span></span>&#123;</span><br><span class="line">        <span class="comment">//TODO 认证，授权</span></span><br><span class="line">        <span class="keyword">return</span> shareService.auditById(id,auditDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareAuditDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AuditStatusEnum auditStatusEnum;</span><br><span class="line">    <span class="keyword">private</span> String reason;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">AuditStatusEnum</span> </span>&#123;</span><br><span class="line">    NOT_YET,</span><br><span class="line">    PASS,</span><br><span class="line">    REJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/155514-198812.png" alt="image-20220106155505489"></p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/160815-705665.png" alt="image-20220106155524559"></p>
</li>
<li><p>引入Mq后的架构<img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/06/160935-155126.png" alt="image-20220106160855440"></p>
</li>
<li><p>mq使用场景</p>
<ul>
<li>异步处理</li>
<li>实现削峰填谷</li>
<li>解耦微服务</li>
</ul>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/07/222808-401149.png" alt="image-20220106161444030"></p>
</li>
<li><p>RocketMq 环境搭建</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.itmuch.com/rocketmq/rocketmq-install/">https://www.itmuch.com/rocketmq/rocketmq-install/</a>    安装rocketmq</li>
<li><a target="_blank" rel="noopener" href="https://www.imooc.com/article/290092">https://www.imooc.com/article/290092</a>  安装控制台程序</li>
<li>启动rocketmq ： 执行 start mqnamesrv.cmd  启动NAMESERVER ，然后 控制台                              start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true    启动broker</li>
<li></li>
</ol>
</li>
<li><p>编写生产者</p>
<ol>
<li><p>```java</p>
  <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>2.0.3</version>
        </dependency>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. &#96;&#96;&#96;properties</span><br><span class="line">   rocketmq:</span><br><span class="line">     name-server: 127.0.0.1:9876</span><br><span class="line">     producer:</span><br><span class="line">       #必须指定group</span><br><span class="line">       group: test-group</span><br></pre></td></tr></table></figure></li>
<li><p>```java<br> rocketMQTemplate.convertAndSend(“add-bonus”, UserAddBonusMsgDTO.builder()</p>
<pre><code>            .bonus(500)
            .userId(share.getUserId())
            .build());
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. &#96;&#96;&#96;java</span><br><span class="line">       public Share auditById(Integer id, ShareAuditDTO auditDTO) &#123;</span><br><span class="line">           &#x2F;&#x2F;1. 查询share是否存在，如果不存在或者status !&#x3D; NOT_YET 的话,抛异常</span><br><span class="line">            Share share &#x3D; shareMapper.selectByPrimaryKey(id);</span><br><span class="line">            if (Objects.isNull(share))&#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;参数非法,该分享不存在&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (!Objects.equals(share.getAuditStatus(),AuditStatusEnum.NOT_YET.toString()))&#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;参数非法，该分享已经审核过了&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">           &#x2F;&#x2F;2. 审核Share PASS&#x2F;REJECT</span><br><span class="line">           share.setAuditStatus(auditDTO.getAuditStatusEnum().toString());</span><br><span class="line">            shareMapper.updateByPrimaryKey(share);</span><br><span class="line">           &#x2F;&#x2F;3. 如果是PASS,为发布人添加积分</span><br><span class="line">   &#x2F;&#x2F;        userCenterFeignClient.addBonus(id,500);</span><br><span class="line">           rocketMQTemplate.convertAndSend(&quot;add-bonus&quot;, UserAddBonusMsgDTO.builder()</span><br><span class="line">                   .bonus(500)</span><br><span class="line">                   .userId(share.getUserId())</span><br><span class="line">                   .build());</span><br><span class="line">           return share;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>编写消费者</p>
<ul>
<li><p>```java</p>
<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
        &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;
        &lt;version&gt;2.0.3&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;properties</span><br><span class="line">  rocketmq:</span><br><span class="line">    name-server: 127.0.0.1:9876</span><br></pre></td></tr></table></figure></li>
<li><p>```java<br>@Service<br>@RocketMQMessageListener(consumerGroup = “consumer-group”,topic = “add-bonus”)<br>public class AddBonusListener implements RocketMQListener<UserAddBonusMsgDTO> {</p>
<pre><code>@Autowired
private UserMapper userMapper;

@Override
public void onMessage(UserAddBonusMsgDTO userAddBonusMsgDTO) &#123;
    User user = userMapper.selectByPrimaryKey(userAddBonusMsgDTO.getUserId());
    user.setBonus(user.getBonus()+userAddBonusMsgDTO.getBonus());
    userMapper.updateByPrimaryKey(user);
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">8. 分布式事务</span><br><span class="line"></span><br><span class="line">   - ​	![image-20220108101450220](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;08&#x2F;101456-598214.png)</span><br><span class="line"></span><br><span class="line">   - RocketMq事务消息![image-20220108101715105](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220108101715105.png)</span><br><span class="line"></span><br><span class="line">     1. 生产者向Mq发送半消息，这种消息会存到MqServer中，但是会被标记为暂时不能投递，所以消费者不会收到这个消息</span><br><span class="line"></span><br><span class="line">     2. 半消息发送成功</span><br><span class="line"></span><br><span class="line">     3. 生产者执行本地事务</span><br><span class="line"></span><br><span class="line">     4. 生产者根据本地事务的成功与否给MQ发送二次确认消息 提交还是回滚，如果收到的是提交，就把半消息标记为可投递，消费者就可以拿到这条消息，回滚则将半消息删除掉</span><br><span class="line"></span><br><span class="line">     5. 如果二次确认没有成功的发送到MqServer，经过一段时间后MqServer 就向生产者发送回查消息，去获取本地事务的执行状态（再发送二次确认的瞬间断网了，或者应用重启了）</span><br><span class="line"></span><br><span class="line">     6. 生产者去检查一下本地事务的执行结果</span><br><span class="line"></span><br><span class="line">     7. 生产者根据本地事务的执行结果告诉MqServer应该是提交还是回滚</span><br><span class="line"></span><br><span class="line">        ![image-20220108103048661](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220108103048661.png)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">   - ![image-20220111133853086](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220111133853086.png)</span><br><span class="line">   </span><br><span class="line">   - &#96;&#96;&#96;java</span><br><span class="line">     @RocketMQTransactionListener(txProducerGroup &#x3D; &quot;tx-add-bonus-group&quot;)</span><br><span class="line">     public class AddBonusTransactionListener implements RocketMQLocalTransactionListener &#123;</span><br><span class="line">     </span><br><span class="line">         @Autowired</span><br><span class="line">         private ShareService shareService;</span><br><span class="line">         @Autowired</span><br><span class="line">         private RocketmqTransactionLogMapper rocketmqTransactionLogMapper;</span><br><span class="line">         @Override</span><br><span class="line">         &#x2F;&#x2F;执行本地事务</span><br><span class="line">         public RocketMQLocalTransactionState executeLocalTransaction(Message message, Object o) &#123;</span><br><span class="line">             MessageHeaders headers &#x3D; message.getHeaders();</span><br><span class="line">             String transactionId &#x3D; (String) headers.get(RocketMQHeaders.TRANSACTION_ID);</span><br><span class="line">             Integer shareId &#x3D; Integer.valueOf( (String)headers.get(&quot;share_id&quot;));</span><br><span class="line">             try &#123;</span><br><span class="line">     </span><br><span class="line">                 this.shareService.auditByIdWithRocketMqLog(shareId,transactionId, (ShareAuditDTO)o);</span><br><span class="line">                 return RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">             &#125;catch (Exception e)&#123;</span><br><span class="line">                 return RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     </span><br><span class="line">         @Override</span><br><span class="line">         &#x2F;&#x2F;本地事务的检查接口 -- 如果mq没有收到二次确认，就回走这个方法，检查本地事务有没有执行成功</span><br><span class="line">         public RocketMQLocalTransactionState checkLocalTransaction(Message message) &#123;</span><br><span class="line">             MessageHeaders headers &#x3D; message.getHeaders();</span><br><span class="line">             String transactionId &#x3D; (String) headers.get(RocketMQHeaders.TRANSACTION_ID);</span><br><span class="line">             RocketmqTransactionLog transactionLog &#x3D; rocketmqTransactionLogMapper.selectOne(RocketmqTransactionLog.builder()</span><br><span class="line">                     .transactionId(transactionId)</span><br><span class="line">                     .build());</span><br><span class="line">             if (Objects.isNull(transactionLog))&#123;</span><br><span class="line">                 return RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">             &#125;else &#123;</span><br><span class="line">                 return RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
</li>
<li><p> SpringCloud Stream    </p>
</li>
</ol>
<pre><code>1. 一个用于构建消息驱动的微服务框架

2. ![image-20220111134539394](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220111134539394.png)应用通过input和output 和 Binder 交互，Binder 是让微服务和消息中间件集成的组件

3. ![image-20220111134812331](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220111134812331.png)![image-20220111134950307](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220111134950307.png)

4. 整合 

   - ```xml
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
         &lt;artifactId&gt;spring-cloud-starter-stream-rocketmq&lt;/artifactId&gt;
     &lt;/dependency&gt;
     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;java</span><br><span class="line">  @EnableBinding(Source.class) &#x2F;&#x2F;启动类添加注解</span><br><span class="line">  public class UserCenterApplication &#123; </span><br></pre></td></tr></table></figure>

   - ```properties
         stream:
           rocketmq:
             binder:
               name-server: 127.0.0.1:9876
             bindings:
               output:
                 destination:stream-test-topic
     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    5. 卡住了....遇到解决不了的问题了...</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">11. 网关</span><br><span class="line"></span><br><span class="line">    1. 为什么使用网关？</span><br><span class="line"></span><br><span class="line">       - 可以简化登录认证，统一的进行登录认证，然后把请求发送到各个微服务，而不需要每个微服务都做登录认证了</span><br><span class="line">       - 采用网关，对外暴露的永远是一个域名，不管微服务如何拆分和重构，域名都不会变，重构的成本降低</span><br><span class="line">       - 如果微服务采用的是浏览器不友好的协议，可以在网关上转换成友好的协议http，websocket</span><br><span class="line"></span><br><span class="line">    2. Spring Cloud Gateway 是什么？</span><br><span class="line"></span><br><span class="line">       - 是Spirng Cloud 第二代网关， 未来取代Zuul</span><br><span class="line">       - 基于Netty，Reactor 以及WebFlux构建</span><br><span class="line">       - 性能强劲  是Zuul 1.x的1.6倍</span><br><span class="line">       - 功能强大，内置了很多实用功能，比如转发，监控，限流等</span><br><span class="line">       - 设计优雅，易扩展</span><br><span class="line">       - 依赖Netty与Webflux ，不是Servlet编程模型，有一定适应成本</span><br><span class="line">       - 不能在Servlet 容器下工作，不能构建war包</span><br><span class="line">       - 不支持springboot 1.x</span><br><span class="line"></span><br><span class="line">    3. 创建项目</span><br><span class="line"></span><br><span class="line">       - &#96;&#96;&#96;xml</span><br><span class="line">         &lt;dependencies&gt;</span><br><span class="line">             &lt;dependency&gt;</span><br><span class="line">                 &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">                 &lt;artifactId&gt;spring-cloud-starter-gateway&lt;&#x2F;artifactId&gt;</span><br><span class="line">             &lt;&#x2F;dependency&gt;</span><br><span class="line">         </span><br><span class="line">             &lt;dependency&gt;</span><br><span class="line">                 &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">                 &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">             &lt;&#x2F;dependency&gt;</span><br><span class="line">         </span><br><span class="line">             &lt;dependency&gt;</span><br><span class="line">                 &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">                 &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;&#x2F;artifactId&gt;</span><br><span class="line">             &lt;&#x2F;dependency&gt;</span><br><span class="line">         </span><br><span class="line">             &lt;dependency&gt;</span><br><span class="line">                 &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                 &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">             &lt;&#x2F;dependency&gt;</span><br><span class="line">         </span><br><span class="line">         &lt;&#x2F;dependencies</span><br></pre></td></tr></table></figure>

   - ```properties
     server:
       port: 8040
     spring:
       cloud:
         nacos:
           discovery:
             server-addr: localhost:8848
         gateway:
           discovery:
             locator:
               # 让gateway 通过服务发现组件找到其他微服务
               enabled: true
       application:
         name: gateway
     management:
       endpoints:
         web:
           exposure:
             include: &#39;*&#39;
       endpoint:
         health:
           show-details: always
     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - ![image-20220113102047466](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;13&#x2F;102637-421042.png)</span><br><span class="line"></span><br><span class="line">   - ![image-20220113102253260](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;13&#x2F;102658-51775.png)</span><br><span class="line"></span><br><span class="line">4. ![image-20220113103332713](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220113103332713.png)</span><br><span class="line"></span><br><span class="line">   - ![image-20220113103656102](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;13&#x2F;103706-175606.png)一个路由由id，uri, predicates, filters 组成，访问  &#x2F;users&#x2F;1 就会进入这个路由，会使用AddRequestHeader 这个filter进行处理，将请求转发到 www.itmuch.com  这个路径</span><br><span class="line"></span><br><span class="line">   - ![image-20220117103740651](https:&#x2F;&#x2F;blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com&#x2F;undefined&#x2F;202201&#x2F;17&#x2F;103739-981288.png)</span><br><span class="line"></span><br><span class="line">   - &#96;&#96;&#96;properties</span><br><span class="line">     spring:</span><br><span class="line">       cloud:</span><br><span class="line">         nacos:</span><br><span class="line">           discovery:</span><br><span class="line">             server-addr: localhost:8848</span><br><span class="line">         gateway:</span><br><span class="line">           discovery:</span><br><span class="line">             locator:</span><br><span class="line">               enabled: true</span><br><span class="line">           routes:</span><br><span class="line">             - id: after-route</span><br><span class="line">               uri: lb:&#x2F;&#x2F;user-center</span><br><span class="line">               predicates:</span><br><span class="line">                 - Before&#x3D;2028-01-20T17:42:47.789-07:00[America&#x2F;Denver]</span><br></pre></td></tr></table></figure>

     表示请求http://localhost:8040/users/1这个路径的时间在2028年之前就能成功，否则就会失败

   - https://www.imooc.com/article/290804 更多配置到这里查看

5. 自定义路由谓词工厂

   - ![image-20220117123212006](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220117123212006.png)

   - ```java
     /**
      * @description: 配置类
      * @author: &lt;a href=&quot;mailto:guang.chen@zkteco.com&quot;&gt;guang.chen&lt;/a&gt;
      * @create: 2022-01-17
      */
     @Data
     public class TimeBetweenConfig &#123;
             private LocalTime start;
             private LocalTime end;
     &#125;
     <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;java</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * @description: 自定义路由谓词工厂,、</span><br><span class="line">      注意类的名称一定是TimeBetween + RoutePredicateFactory 才能生效</span><br><span class="line">   * @author: &lt;a href&#x3D;&quot;mailto:guang.chen@zkteco.com&quot;&gt;guang.chen&lt;&#x2F;a&gt;</span><br><span class="line">   * @create: 2022-01-17</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Component</span><br><span class="line">  public class TimeBetweenRoutePredicateFactory  extends AbstractRoutePredicateFactory&lt;TimeBetweenConfig&gt; &#123;</span><br><span class="line">  </span><br><span class="line">      public TimeBetweenRoutePredicateFactory() &#123;</span><br><span class="line">          super(TimeBetweenConfig.class);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      @Override</span><br><span class="line">      public Predicate&lt;ServerWebExchange&gt; apply(TimeBetweenConfig config) &#123;</span><br><span class="line">          LocalTime start &#x3D; config.getStart();</span><br><span class="line">          LocalTime end &#x3D; config.getEnd();</span><br><span class="line">          return exc-&gt;&#123;</span><br><span class="line">              LocalTime now &#x3D; LocalTime.now();</span><br><span class="line">              return now.isBefore(end) &amp;&amp; now.isAfter(start);</span><br><span class="line">          &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      @Override</span><br><span class="line">      public List&lt;String&gt; shortcutFieldOrder() &#123;</span><br><span class="line">  &#x2F;&#x2F;        - TimeBetween&#x3D;9:00, 17:00   将第一个参数赋值给 config类的start 字段， 第二个参数赋值给 end 字段</span><br><span class="line">          return Arrays.asList(&quot;start&quot;,&quot;end&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      &#x2F;&#x2F; 查看默认的时间格式 --下午12:03</span><br><span class="line">      public static void main(String[] args) &#123;</span><br><span class="line">          DateTimeFormatter dateTimeFormatter &#x3D; DateTimeFormatter.ofLocalizedTime(FormatStyle.SHORT);</span><br><span class="line">          System.out.println(dateTimeFormatter.format(LocalTime.now()));</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

6. 过滤器工厂 可以灵活的操作请求和响应 

   http://www.imooc.com/article/290816/

7. 自定义过滤器工厂

   - ![image-20220121090331605](https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/21/090535-621507.png)

   - ![image-20220121090513189](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220121090513189.png)

   - &lt;img src=&quot;C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220121090557096.png&quot; alt=&quot;image-20220121090557096&quot; style=&quot;zoom:67%;&quot; /&gt;

   - ![image-20220121090806068](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220121090806068.png)

   - ![image-20220121090813018](https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/21/090815-537163.png)

   - 第二种方式是第一种方式的简化方式

   - ![image-20220121091221569](https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/21/091224-655170.png) 

   - ![image-20220121091246942](https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202201/21/091254-520807.png)

   - ```java
     /**
      * @description: 自定义过滤器工厂 类名称以GatewayFilterFactory结束
      * @author: &lt;a href=&quot;mailto:guang.chen@zkteco.com&quot;&gt;guang.chen&lt;/a&gt;
      * @create: 2022-01-21
      */
     @Slf4j
     @Component
     public class PreLogGatewayFilterFactory extends AbstractNameValueGatewayFilterFactory &#123;
         @Override
         public GatewayFilter apply(NameValueConfig config) &#123;
             return (exchange, chain) -&gt; &#123;
                 //业务写到匿名内部类里面
     
     //          filters:
     //            - PreLog=a,b
                 log.info(&quot;请求进来了....&#123;&#125;,&#123;&#125;&quot;,config.getName(),config.getValue());
                 ServerHttpRequest modifiedRequest = exchange.getRequest().mutate().build();
                 ServerWebExchange modifiedExchange = exchange.mutate().request(modifiedRequest).build();
                 return chain.filter(modifiedExchange);
             &#125;;
         &#125;
     &#125;
     ```

   - ![image-20220121094110132](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220121094110132.png)

   - 

8. 全局过滤器， 用来过滤所有的路由，有执行顺序的概念，order的数字越小越先执行  http://www.imooc.com/article/290821

9. 监控springcloud gateway 

   - ![image-20220124083636346](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220124083636346.png)
   - ![image-20220124083705448](C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220124083705448.png)
   - 可以新增路由，新增路由之后使用routes没查看到，是因为需要刷新一下缓存，就好了。
   - http://www.imooc.com/article/290822

10. gateway 调试，排错相关：http://www.imooc.com/article/290824

11. 

15. 

    - 
</code></pre>
<ol start="12">
<li><p>认证和授权</p>
<ol>
<li><p>无状态</p>
<p>所谓的无状态，就是服务器端不记录用户的登录状态，服务器端不再维持session了，这样对微服务架构是有好处的，如果每一个微服务都将用户信息存入到session中，由sessionStore来管理的话，相当于又将鸡蛋放到了一个篮子里面，如果sessionStore挂了或者要迁移，这都是问题。</p>
<p><img src="C:\Users\陈广\AppData\Roaming\Typora\typora-user-images\image-20220205175521900.png" alt="image-20220205175521900"></p>
<p>无状态</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/05/183145-961858.png" alt="image-20220205180140403"></p>
<p>服务器不会存储用户的登录状态，用户在登录的时候给用户颁发一个token，之后用户的每个请求都会带上这个token，放在header或者url中传递，服务器收到后就解密一下，检验token是否过期，是否合法来判断用户有没有登录</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/05/180331-447752.png" alt="image-20220205180325858"></p>
</li>
<li><p>方案</p>
<ul>
<li><p>处处安全 方案</p>
</li>
<li><p>外部无状态，内部有状态方案</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/05/183137-697447.png" alt="image-20220205181208678"></p>
<p>用户带着jsessionid或者token访问网关，如果网关打到了旧的服务上面，就去sessionStore中查询一下有没有这个人，有就登录了，如果网关打到了新的服务上，就解密token看看有没有登录，这种方案适合重构中的系统</p>
</li>
<li><p>网关认证授权，内部裸奔方案</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/05/183131-830194.png" alt="image-20220205181456423"></p>
<p>请求在网关上做登录认证，登录成功后就会给用户颁发token，用户登录成功后会带着token 来请求，网关会解密这个token，token 中存储着一些信息比如userId，username,等信息，也在网关这里解析出来，然后放到header中转发到各个微服务中。</p>
<p>优点：实现简单，性能不错</p>
<p>缺点；一旦网关的加密被攻破，就有点尬了</p>
</li>
<li><p>内部裸奔方案改进</p>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/05/183123-818447.png" alt="image-20220205182610210"></p>
</li>
<li><p>用户登录的时候网关打到认证授权中心，来获取token，并返回给用户，用户每次请求都带着token，网关不做任何处理，每个微服务接收到请求后都需要解析token，内部请求也需要解析token</p>
<p>优点： 相对安全</p>
<p>缺点： 解析token需要一个密钥，微服务越多，知道密钥的人也就越多，一旦泄露，就gg了，可以通过配置中心来改进，或则定期更换密钥</p>
</li>
<li><p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/08/083424-577484.png" alt="image-20220205183118518"></p>
</li>
</ul>
</li>
<li><p>JWT技术</p>
<p>jwt 是json web token 的简称，是一个开放标准，在各方之间安全的传输信息。 </p>
<table>
<thead>
<tr>
<th>组成</th>
<th>作用</th>
<th>内容实例</th>
</tr>
</thead>
<tbody><tr>
<td>Header(头)</td>
<td>记录令牌类型，签名的算法等</td>
<td>{“alg”:”HS256,”typ”:”JWT”}</td>
</tr>
<tr>
<td>Payload(有效载荷)</td>
<td>携带一些用户信息(非敏感信息)</td>
<td>{“userId”:”1”,”username”:”damu”}</td>
</tr>
<tr>
<td>Signture(签名)</td>
<td>防止Token被篡改，确保安全性</td>
<td>计算出来的签名，一个字符串</td>
</tr>
</tbody></table>
<p><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202202/08/084527-700065.png" alt=" "></p>
<p>代码以及工具类：<a target="_blank" rel="noopener" href="http://www.imooc.com/article/290892">http://www.imooc.com/article/290892</a></p>
</li>
<li><p>s</p>
</li>
<li><p>是、</p>
</li>
<li><p>sd</p>
</li>
<li></li>
</ol>
</li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><ol>
<li></li>
<li></li>
<li></li>
</ol>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://18844683936.github.io">Charles</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://18844683936.github.io/2021/06/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">https://18844683936.github.io/2021/06/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://18844683936.github.io" target="_blank">Butterfly</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/144952-851510.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/07/14/%E8%8B%B1%E8%AF%AD%E5%8F%A3%E8%AF%AD/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2021/06/28/Actuator/" title="Actuator"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Actuator</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/144952-851510.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Charles</div><div class="author-info__description">Happy Life</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">91</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">微服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86"><span class="toc-number">3.</span> <span class="toc-text">微服务拆分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.1.</span> <span class="toc-text">创建项目</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number"></span> <span class="toc-text">搭建环境</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/15/GovernarTI/" title="GovernarTI">GovernarTI</a><time datetime="2023-02-15T14:51:02.000Z" title="发表于 2023-02-15 12:51:02">2023-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/15/ZKCV%E5%AE%9A%E5%88%B6%E6%96%87%E6%A1%A3/" title="ZKCV定制文档"><img src="https://blog-1305043867.cos.ap-shenzhen-fsi.myqcloud.com/undefined/202212/15/153449-136730.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ZKCV定制文档"/></a><div class="content"><a class="title" href="/2022/12/15/ZKCV%E5%AE%9A%E5%88%B6%E6%96%87%E6%A1%A3/" title="ZKCV定制文档">ZKCV定制文档</a><time datetime="2022-12-15T13:21:10.000Z" title="发表于 2022-12-15 11:21:10">2022-12-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/06/25/ms/" title="Spring">Spring</a><time datetime="2022-06-25T19:51:01.000Z" title="发表于 2022-06-25 16:51:01">2022-06-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/06/08/docker/" title="docker">docker</a><time datetime="2022-06-08T12:35:27.000Z" title="发表于 2022-06-08 09:35:27">2022-06-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/26/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" title="桥接模式">桥接模式</a><time datetime="2022-04-26T11:28:43.000Z" title="发表于 2022-04-26 08:28:43">2022-04-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Charles</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>